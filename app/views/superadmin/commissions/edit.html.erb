<div class="min-h-screen bg-slate-100 p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">

    <div class="bg-gradient-to-r from-yellow-600 to-yellow-700 px-8 py-6">
      <h1 class="text-2xl font-bold text-white">
        Edit BBPS and Recharge & DTH Commission
      </h1>
      <p class="text-yellow-100 mt-1 text-sm">
        Configure commission distribution
      </p>
    </div>

    <div class="p-8 space-y-10">

      <%= form_with url: superadmin_commission_path(@commission),
            method: :patch,
            local: true,
            class: "space-y-10" do |f| %>

        <!-- SCHEME -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Scheme *
          </label>

          <%= select_tag :scheme_id,
                options_from_collection_for_select(
                  @schemes,
                  :id,
                  :scheme_name,
                  params[:scheme_id].presence || @commission.scheme_id
                ),
                class: "w-full rounded-lg border px-4 py-2.5" %>
        </div>

        <!-- CATEGORY -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Category *
          </label>

          <%= select_tag :category_id,
                options_from_collection_for_select(
                  @categories,
                  :id,
                  :title,
                  params[:category_id].presence ||
                  @commission.service_product_item.service_product.category_id
                ),
                class: "w-full rounded-lg border px-4 py-2.5",
                onchange: "
                  this.form.action='#{edit_superadmin_commission_path(@commission)}';
                  this.form.method='get';
                  this.form.submit();
                " %>
        </div>

        <!-- SERVICE -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Service *
          </label>

          <%= select_tag :service_product_id,
                options_from_collection_for_select(
                  @service_products,
                  :id,
                  :company_name,
                  params[:service_product_id].presence ||
                  @commission.service_product_item.service_product_id
                ),
                class: "w-full rounded-lg border px-4 py-2.5",
                onchange: "
                  this.form.action='#{edit_superadmin_commission_path(@commission)}';
                  this.form.method='get';
                  this.form.submit();
                " %>
        </div>

        <!-- OPERATOR -->
        <div class="relative">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Operator *
          </label>

          <input
            type="text"
            id="operatorSearch"
            value="<%= params[:operator_name].presence || @commission.service_product_item.name %>"
            class="w-full rounded-lg border px-4 py-2.5"
          >

          <%= hidden_field_tag :operator_name,
                params[:operator_name].presence || @commission.service_product_item.name,
                id: "operatorHidden" %>

          <ul
            id="operatorDropdown"
            class="absolute z-30 mt-1 w-full max-h-56 overflow-y-auto
                   rounded-lg border bg-white shadow-lg hidden"
          >
            <% @operators.each do |op| %>
              <li
                class="operator-item px-4 py-2 text-sm cursor-pointer
                       hover:bg-yellow-50"
                data-name="<%= op['name'] %>"
              >
                <%= op['name'] %>
              </li>
            <% end %>
          </ul>
        </div>

        <!-- COMMISSION -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Admin Commission (%)
          </label>

          <%= f.number_field :admin_commission,
                value: @commission.value,
                step: 0.01,
                class: "w-full rounded-lg border px-4 py-2.5" %>
        </div>

        <div class="pt-6 border-t flex justify-end">
          <%= f.submit "Update Commission",
                class: "px-8 py-3 bg-yellow-600 text-white rounded-lg" %>
        </div>

      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("operatorSearch");
  const dropdown = document.getElementById("operatorDropdown");
  const hiddenInput = document.getElementById("operatorHidden");

  searchInput.addEventListener("focus", () => dropdown.classList.remove("hidden"));

  searchInput.addEventListener("input", () => {
    const val = searchInput.value.toLowerCase();
    document.querySelectorAll(".operator-item").forEach(item => {
      item.style.display = item.dataset.name.toLowerCase().includes(val)
        ? "block" : "none";
    });
  });

  document.querySelectorAll(".operator-item").forEach(item => {
    item.addEventListener("click", () => {
      searchInput.value = item.dataset.name;
      hiddenInput.value = item.dataset.name;
      dropdown.classList.add("hidden");
    });
  });

  document.addEventListener("click", e => {
    if (!e.target.closest(".relative")) dropdown.classList.add("hidden");
  });
});
</script>
